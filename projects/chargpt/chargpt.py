"""
Trains a character-level language model.
"""

import os
import sys

import torch
from torch.utils.data import Dataset
from torch.utils.data.dataloader import DataLoader

from mingpt.model import GPT
from mingpt.trainer_te import Trainer
from mingpt.utils import set_seed, setup_logging, CfgNode as CN

# -----------------------------------------------------------------------------

def get_config():

    C = CN()

    C.system = CN()
    C.system.seed = 3407
    C.system.work_dir = './out/chargpt'

    # data
    C.data = CharDataset.get_default_config()

    # model
    C.model = GPT.get_default_config()
    C.model.model_type = 'gpt-mini'

    # trainer
    C.trainer = Trainer.get_default_config()
    C.trainer.learning_rate = 5e-6 # the model we're using is so small that we can go a bit faster

    return C

# -----------------------------------------------------------------------------

class CharDataset(Dataset):
    """
    Emits batches of characters
    """

    @staticmethod
    def get_default_config():
        C = CN()
        C.block_size = 256
        return C

    def __init__(self, config, data):
        self.config = config

        chars = sorted(list(set(data)))
        data_size, vocab_size = len(data), len(chars)
        print('data has %d characters, %d unique.' % (data_size, vocab_size))

        self.stoi = { ch:i for i,ch in enumerate(chars) }
        self.itos = { i:ch for i,ch in enumerate(chars) }
        self.vocab_size = vocab_size
        self.data = data

    def get_vocab_size(self):
        return self.vocab_size

    def get_block_size(self):
        return self.config.block_size

    def __len__(self):
        return len(self.data) - self.config.block_size

    def __getitem__(self, idx):
        # grab a chunk of (block_size + 1) characters from the data
        chunk = self.data[idx:idx + self.config.block_size + 1]
        # encode every character to an integer
        dix = [self.stoi[s] for s in chunk]
        # return as tensors
        x = torch.tensor(dix[:-1], dtype=torch.long)
        y = torch.tensor(dix[1:], dtype=torch.long)
        return x, y

# -----------------------------------------------------------------------------
def generate(prompt='', num_samples=200, steps=20, do_sample=True):
        
    # tokenize the input prompt into integer input sequence
    if use_mingpt:
        tokenizer = BPETokenizer()
        if prompt == '':
            # to create unconditional samples...
            # manually create a tensor with only the special <|endoftext|> token
            # similar to what openai's code does here https://github.com/openai/gpt-2/blob/master/src/generate_unconditional_samples.py
            x = torch.tensor([[tokenizer.encoder.encoder['<|endoftext|>']]], dtype=torch.long)
        else:
            x = tokenizer(prompt).to(device)
    else:
        tokenizer = GPT2Tokenizer.from_pretrained(model_type)
        if prompt == '': 
            # to create unconditional samples...
            # huggingface/transformers tokenizer special cases these strings
            prompt = '<|endoftext|>'
        encoded_input = tokenizer(prompt, return_tensors='pt').to(device)
        x = encoded_input['input_ids']
    
    # we'll process all desired num_samples in a batch, so expand out the batch dim
    x = x.expand(num_samples, -1)

    # forward the model `steps` times to get samples, in a batch
    y = model.generate(x, max_new_tokens=steps, do_sample=do_sample, top_k=40)
    
    for i in range(num_samples):
        out = tokenizer.decode(y[i].cpu().squeeze())
        print('-'*80)
        print(out)


if __name__ == '__main__':

    # get default config and overrides from the command line, if any
    config = get_config()
    config.merge_from_args(sys.argv[1:])
    print(config)
    setup_logging(config)
    set_seed(config.system.seed)

    # construct the training dataset
    text = open('/home/letina/Desktop/new/test/minGPT/projects/chargpt/test/a.dxf', 'r').read() # don't worry we won't run out of file handles
    train_dataset = CharDataset(config.data, text)
    
    # construct the model
    config.model.vocab_size = train_dataset.get_vocab_size()
    config.model.block_size = train_dataset.get_block_size()
    model = GPT(config.model)

    # construct the trainer object
    trainer = Trainer(config.trainer, model, train_dataset)

    # iteration callback
    def batch_end_callback(trainer):

        if trainer.iter_num % 10 == 0:
            print(f"iter_dt {trainer.iter_dt * 1000:.2f}ms; iter {trainer.iter_num}: train loss {trainer.loss.item():.5f}")

        if trainer.iter_num % 500 == 0:
            # evaluate both the train and test score
            model.eval()
            with torch.no_grad():
                # sample from the model...
                context = """SECTION
  2
ENTITIES
  0
TEXT
  5
1171E
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
373.2925048500418
 20
253.6133189556237
 30
0.0
 40
1.08472396668239
  1
PROJECT TITLE
 41
1.002348502541445
  7
HSW
 11
373.2925048500418
 21
253.4686890933994
 31
0.0
100
AcDbText
 73
     1
  0
TEXT
  5
1171F
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
373.2925048500418
 20
235.0855714684422
 30
0.0
 40
1.08472396668239
  1
NOTES
 41
1.002348502541445
  7
HSW
 11
373.2925048500418
 21
234.9409416062179
 31
0.0
100
AcDbText
 73
     1
  0
LINE
  5
11720
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
169.240045348476
 30
0.0
 11
407.2177480575156
 21
169.240045348476
 31
0.0
  0
LINE
  5
11721
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
173.5789412152123
 30
0.0
 11
407.2177480575156
 21
173.5789412152123
 31
0.0
  0
LINE
  5
11722
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
164.9011494817399
 30
0.0
 11
407.2177480575156
 21
164.9011494817399
 31
0.0
  0
LINE
  5
11723
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
156.2233577482966
 30
0.0
 11
407.2177480575156
 21
156.2233577482966
 31
0.0
  0
LINE
  5
11724
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
160.5622536150183
 30
0.0
 11
407.2177480575156
 21
160.5622536150183
 31
0.0
  0
LINE
  5
11725
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
225.645691615959
 30
0.0
 11
407.2177480575156
 21
225.645691615959
 31
0.0
  0
LINE
  5
11726
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
216.9678998825012
 30
0.0
 11
407.2177480575156
 21
216.9678998825012
 31
0.0
  0
LINE
  5
11727
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
221.3067957492228
 30
0.0
 11
407.2177480575156
 21
221.3067957492228
 31
0.0
  0
LINE
  5
11728
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
190.9345246821278
 30
0.0
 11
407.2177480575156
 21
190.9345246821278
 31
0.0
  0
LINE
  5
11729
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
195.2734205488495
 30
0.0
 11
407.2177480575156
 21
195.2734205488495
 31
0.0
  0
LINE
  5
1172A
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
199.6123164155856
 30
0.0
 11
407.2177480575156
 21
199.6123164155856
 31
0.0
  0
LINE
  5
1172B
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
203.9512122823218
 30
0.0
 11
407.2177480575156
 21
203.9512122823218
 31
0.0
  0
LINE
  5
1172C
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
208.2901081490434
 30
0.0
 11
407.2177480575156
 21
208.2901081490434
 31
0.0
  0
LINE
  5
1172D
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
212.629004015765
 30
0.0
 11
407.2177480575156
 21
212.629004015765
 31
0.0
  0
LINE
  5
1172E
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
177.9178370819338
 30
0.0
 11
407.2177480575156
 21
177.9178370819338
 31
0.0
  0
LINE
  5
1172F
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
182.25673294867
 30
0.0
 11
407.2177480575156
 21
182.25673294867
 31
0.0
  0
LINE
  5
11730
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
186.5956288153916
 30
0.0
 11
407.2177480575156
 21
186.5956288153916
 31
0.0
  0
LINE
  5
11731
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.4250618599818
 20
255.5429947923394
 30
0.0
 11
407.2177480575155
 21
255.5429947923394
 31
0.0
  0
LINE
  5
11732
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.4250618599818
 20
237.1762398321469
 30
0.0
 11
407.2177480575155
 21
237.1762398321469
 31
0.0
  0
TEXT
  5
11733
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
400.1365189878924
 20
132.5523047866085
 30
0.0
 40
1.08472396668239
  1
DATE
 41
1.002348502541445
  7
HSW
 11
400.1365189878924
 21
132.4076749243842
 31
0.0
100
AcDbText
 73
     1
  0
TEXT
  5
11734
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
373.2925048500418
 20
132.5523047866085
 30
0.0
 40
1.08472396668239
  1
REVISION DESCRIPTION
 41
1.002348502541445
  7
HSW
 11
373.2925048500418
 21
132.4076749243842
 31
0.0
100
AcDbText
 73
     1
  0
TEXT
  5
11735
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
373.2925048500418
 20
44.69509663183406
 30
0.0
 40
1.084723966682375
  1
DATE
 41
1.002348502541458
  7
HSW
 11
373.2925048500418
 21
44.55046676960975
 31
0.0
100
AcDbText
 73
     1
  0
TEXT
  5
11736
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
373.2925048500418
 20
62.81959937029229
 30
0.0
 40
1.084723966682375
  1
NAME OF DRAWING
 41
1.002348502541458
  7
HSW
 11
373.2925048500418
 21
62.67496950806797
 31
0.0
100
AcDbText
 73
     1
  0
LINE
  5
11737
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
99.81771148079916
 30
0.0
 11
407.2177480575156
 21
99.81771148079916
 31
0.0
  0
LINE
  5
11738
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
95.47881561407755
 30
0.0
 11
407.2177480575156
 21
95.47881561407755
 31
0.0
  0
TEXT
  5
11739
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
390.6888479488088
 20
44.69509663183406
 30
0.0
 40
1.084723966682375
  1
SCALE
 41
1.002348502541458
  7
HSW
 11
390.6888479488088
 21
44.55046676960975
 31
0.0
100
AcDbText
 73
     1
  0
LINE
  5
1173A
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.425061859982
 20
46.33825252935452
 30
0.0
 11
407.2177480575156
 21
46.33825252935452
 31
0.0
  0
LINE
  5
1173B
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
91.13991974734137
 30
0.0
 11
407.2177480575156
 21
91.13991974734137
 31
0.0
  0
LINE
  5
1173C
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
121.5121908144509
 30
0.0
 11
407.2177480575156
 21
121.5121908144509
 31
0.0
  0
LINE
  5
1173D
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
125.8510866811871
 30
0.0
 11
407.2177480575156
 21
125.8510866811871
 31
0.0
  0
LINE
  5
1173E
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
104.1566073475353
 30
0.0
 11
407.2177480575156
 21
104.1566073475353
 31
0.0
  0
LINE
  5
1173F
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
108.4955032142715
 30
0.0
 11
407.2177480575156
 21
108.4955032142715
 31
0.0
  0
LINE
  5
11740
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
112.8343990809931
 30
0.0
 11
407.2177480575156
 21
112.8343990809931
 31
0.0
  0
LINE
  5
11741
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
117.1732949477148
 30
0.0
 11
407.2177480575156
 21
117.1732949477148
 31
0.0
  0
LINE
  5
11742
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
143.2066701481027
 30
0.0
 11
407.2177480575156
 21
143.2066701481027
 31
0.0
  0
LINE
  5
11743
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
138.8677742813811
 30
0.0
 11
407.2177480575156
 21
138.8677742813811
 31
0.0
  0
LINE
  5
11744
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
147.5455660148243
 30
0.0
 11
407.2177480575156
 21
147.5455660148243
 31
0.0
  0
LINE
  5
11745
330
18
100
AcDbEntity
  8
0
  6
Continuous
100
AcDbLine
 10
372.425061859982
 20
151.8844618815605
 30
0.0
 11
407.2177480575156
 21
151.8844618815605
 31
0.0
  0
LINE
  5
11746
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.4250618599818
 20
134.528878414645
 30
0.0
 11
407.2177480575155
 21
134.528878414645
 31
0.0
  0
LINE
  5
11747
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.4250618599818
 20
86.80102388061977
 30
0.0
 11
407.2177480575155
 21
86.80102388061977
 31
0.0
  0
LINE
  5
11748
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.4250618599818
 20
65.106544546968
 30
0.0
 11
407.2177480575155
 21
65.106544546968
 31
0.0
  0
LINE
  5
11749
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
394.183079962061
 20
12.65115032219681
 30
0.0
 11
391.4649013528494
 21
12.65115032219681
 31
0.0
  0
LINE
  5
1174A
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
391.4649013528494
 20
12.65115032219681
 30
0.0
 11
391.4649013528494
 21
15.90532222223803
 31
0.0
  0
LINE
  5
1174B
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
391.4649013528494
 20
15.90532222223803
 30
0.0
 11
394.183079962061
 21
15.90532222223803
 31
0.0
  0
LINE
  5
1174C
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
394.183079962061
 20
15.90532222223803
 30
0.0
 11
394.183079962061
 21
12.65115032219681
 31
0.0
  0
LINE
  5
1174D
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
394.7267156838098
 20
12.65115032219681
 30
0.0
 11
397.4448942930214
 21
12.65115032219681
 31
0.0
  0
LINE
  5
1174E
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
397.4448942930214
 20
12.65115032219681
 30
0.0
 11
397.4448942930214
 21
15.90532222223803
 31
0.0
  0
LINE
  5
1174F
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
397.4448942930214
 20
15.90532222223803
 30
0.0
 11
394.7267156838098
 21
15.90532222223803
 31
0.0
  0
LINE
  5
11750
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
394.7267156838098
 20
15.90532222223803
 30
0.0
 11
394.7267156838098
 21
12.65115032219681
 31
0.0
  0
TEXT
  5
11751
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
373.2925048500418
 20
28.4242371315989
 30
0.0
 40
1.084723966682375
  1
CHECKED BY
 41
1.002348502541458
  7
HSW
 11
373.2925048500418
 21
28.27960726937458
 31
0.0
100
AcDbText
 73
     1
  0
TEXT
  5
11752
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
373.2925048500418
 20
20.2888073814813
 30
0.0
 40
1.084723966682379
  1
DRAWING NO
 41
1.002348502541455
  7
HSW
 11
373.2925048500418
 21
20.14417751925698
 31
0.0
100
AcDbText
 73
     1
  0
TEXT
  5
11753
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
373.2925048500418
 20
36.55966688171648
 30
0.0
 40
1.084723966682375
  1
DRAWN BY
 41
1.002348502541458
  7
HSW
 11
373.2925048500418
 21
36.41503701949217
 31
0.0
100
AcDbText
 73
     1
  0
LINE
  5
11754
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
384.941272690812
 20
12.65115032219681
 30
0.0
 11
382.2230940816004
 21
12.65115032219681
 31
0.0
  0
LINE
  5
11755
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
382.2230940816004
 20
12.65115032219681
 30
0.0
 11
382.2230940816004
 21
15.90532222223803
 31
0.0
  0
LINE
  5
11756
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
382.2230940816004
 20
15.90532222223803
 30
0.0
 11
384.941272690812
 21
15.90532222223803
 31
0.0
  0
LINE
  5
11757
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
384.941272690812
 20
15.90532222223803
 30
0.0
 11
384.941272690812
 21
12.65115032219681
 31
0.0
  0
TEXT
  5
11758
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
390.6888479488088
 20
28.4242371315989
 30
0.0
 40
1.084723966682375
  1
APPROVED BY
 41
1.002348502541458
  7
HSW
 11
390.6888479488088
 21
28.27960726937458
 31
0.0
100
AcDbText
 73
     1
  0
LINE
  5
11759
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.425061859982
 20
21.9319632790163
 30
0.0
 11
407.2177480575156
 21
21.9319632790163
 31
0.0
  0
LINE
  5
1175A
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.425061859982
 20
30.06739302911934
 30
0.0
 11
407.2177480575156
 21
30.06739302911934
 31
0.0
  0
LINE
  5
1175B
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
388.2030870217724
 20
12.65115032219681
 30
0.0
 11
390.9212656309837
 21
12.65115032219681
 31
0.0
  0
LINE
  5
1175C
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
390.9212656309837
 20
12.65115032219681
 30
0.0
 11
390.9212656309837
 21
15.90532222223803
 31
0.0
  0
LINE
  5
1175D
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
390.9212656309837
 20
15.90532222223803
 30
0.0
 11
388.2030870217724
 21
15.90532222223803
 31
0.0
  0
LINE
  5
1175E
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
388.2030870217724
 20
15.90532222223803
 30
0.0
 11
388.2030870217724
 21
12.65115032219681
 31
0.0
  0
TEXT
  5
1175F
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
390.6888479488088
 20
36.55966688171648
 30
0.0
 40
1.084723966682375
  1
DESIGNED BY
 41
1.002348502541458
  7
HSW
 11
390.6888479488088
 21
36.41503701949217
 31
0.0
100
AcDbText
 73
     1
  0
LINE
  5
11760
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
372.425061859982
 20
38.20282277923693
 30
0.0
 11
407.2177480575156
 21
38.20282277923693
 31
0.0
  0
LINE
  5
11761
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
389.8214049587488
 20
46.33825252935452
 30
0.0
 11
389.8214049587488
 21
21.9319632790163
 31
0.0
  0
TEXT
  5
1176B
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
377.8697453974079
 20
41.10518446328373
 30
0.0
 40
1.499999946826463
  1
2011. 5.
 41
1.002348502541454
  7
M
 72
     1
 11
381.8387650429053
 21
41.85518443669696
 31
0.0
100
AcDbText
 73
     2
  0
LINE
  5
1176C
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
385.4849084126776
 20
14.23630135577268
 30
0.0
 11
387.6594513000233
 21
14.23630135577268
 31
0.0
  0
LINE
  5
1176D
330
18
100
AcDbEntity
  8
0
100
AcDbLine
 10
385.4849084126776
 20
14.23630135577268
 30
0.0
 11
387.6594513000233
 21
14.23630135577268
 31
0.0
  0
LWPOLYLINE
  5
1176F
330
18
100
AcDbEntity
  8
0
100
AcDbPolyline
 90
        4
 70
     1
 43
1.0
 10
407.2177480575155
 20
9.999999645502736
 10
12.63149992341612
 20
9.999999645502736
 10
12.63149992341612
 20
286.9999898261293
 10
407.2177480575156
 20
286.9999898261294
  0
LWPOLYLINE
  5
11770
330
18
100
AcDbEntity
  8
0
100
AcDbPolyline
 90
        2
 70
     0
 43
1.0
 10
372.4250618599818
 20
9.999999645502736
 10
372.4250618599818
 20
286.9999898261293
  0
MTEXT
  5
1177D
330
18
100
AcDbEntity
  8
0
100
AcDbMText
 10
389.8214049587486
 20
245.0109259662371
 30
0.0
 40
1.9
 41
32.90666666666667
 46
0.0
 71
     5
 72
     5
  1
수문관측소 통신시스템개선
  7
style1
 73
     1
 44
1.0
  0
POINT
  5
1178D
330
18
100
AcDbEntity
  8
0
 62
     1
100
AcDbPoint
 10
0.0
 20
296.9999894716321
 30
0.0
  0
POINT
  5
1178E
330
18
100
AcDbEntity
  8
0
 62
     1
100
AcDbPoint
 10
0.0
 20
0.0
 30
0.0
  0
POINT
  5
1178F
330
18
100
AcDbEntity
  8
0
 62
     1
100
AcDbPoint
 10
419.9999899736615
 20
-0.0000000000000013
 30
0.0
  0
POINT
  5
11790
330
18
100
AcDbEntity
  8
0
 62
     1
100
AcDbPoint
 10
419.9999899736615
 20
296.9999894716321
 30
0.0
  0
TEXT
  5
117BB
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
375.8152578363168
 20
67.72578626308719
 30
0.0
 40
3.315
  1
(주) 안세기술
 41
1.1
  7
2
 72
     1
 11
389.5306559613168
 21
66.64012376308719
 31
0.0
100
AcDbText
 73
     1
  0
TEXT
  5
117BC
330
18
100
AcDbEntity
  8
0
100
AcDbText
 10
375.0536891375023
 20
73.48384123024819
 30
0.0
 40
2.145
  1
SI/IT Engineering
 41
1.17
  7
1
 72
     1
 11
389.5776210523959
 21
73.0702441557801
 31
0.0
100
AcDbText
 73
     1
  0
CIRCLE
  5
117CD
102
{ACAD_REACTORS
330
1181C
102
}
330
18
100
AcDbEntity
  8
0
 62
     0
100
AcDbCircle
 10
380.9053623476497
 20
80.0749858473665
 30
0.0
 40
0.8788929241270166
  0
ARC
  5
117D3
330
18
100
AcDbEntity
  8
0
 62
     0
100
AcDbCircle
 10
378.0670115084018
 20
72.66346592149738
 30
0.0
 40
10.76382286185366
100
AcDbArc
 50
46.59137029625889
 51
87.73485115316078
  0
ARC
  5
117D5
330
18
100
AcDbEntity
  8
0
 62
     5
100
AcDbCircle
 10
381.4638848373382
 20
83.55840396322695
 30
0.0
 40
5.496972094863258
100
AcDbArc
 50
216.41555933168
 51
263.1201587911766
  0
HATCH
  5
11819
330
18
100
AcDbEntity
  8
0
 62
     0
100
AcDbHatch
 10
0.0
 20
0.0
 30
0.0
210
0.0
220
0.0
230
1.0
  2
SOLID
 70
     1
 71
     0
 91
        2
 92
        7
 72
     1
 73
     1
 93
       22
 10
393.0863605853108
 20
85.74241434952495
 42
0.0
 10
391.0263375217976
 20
85.74241434952492
 42
-0.0444306076850868
 10
385.6167997227579
 20
80.32156400786769
 42
0.0111903001150119
 10
385.46387761294
 20
80.48307297255161
 42
0.1814760555881151
 10
378.4924409271329
 20
83.4188781595774
 42
0.7154719061178916
 10
377.0402920928261
 20
80.29519550491409
 42
0.2066559664463454
 10
380.8054160596518
 20
78.10101254602793
 42
0.1905118465107888
 10
381.560428138197
 20
78.31943885894196
 42
0.2711387510660281
 10
381.5405612975449
 20
79.30235266886548
 42
0.1004338674098498
 10
381.474170954791
 20
79.40497872761149
 42
-0.1655417969168201
 10
380.9472462804277
 20
79.19709148683354
 42
0.0602541338383363
 10
380.9544323924105
 20
79.12364092772168
 42
-0.2520704509015614
 10
380.8054160596517
 20
78.59743473041725
 42
-0.1417944355818891
 10
379.9741285375259
 20
78.55337027038706
 42
-0.1558632110102083
 10
377.4766141993792
 20
80.59035182351728
 42
-0.6422762182135455
 10
378.7110182523348
 20
83.08637227187515
 42
-0.2626301345606501
 10
385.0208509563196
 20
79.83100605840664
 42
-0.0286480895057381
 10
381.0045060976542
 20
76.94862782523428
 42
0.0
 10
382.8109641450008
 20
76.94862782523428
 42
0.0
 10
385.2849317795443
 20
79.27061749042713
 42
-0.0090316833539885
 10
385.4858784107579
 20
76.94862782523428
 42
0.0
 10
387.9568720681243
 20
76.94862782523428
 42
0.0
 97
        0
 92
       22
 72
     1
 73
     1
 93
        3
 10
386.5816855629677
 20
78.74217001173628
 42
0.0695959278145242
 10
385.9215233139504
 20
79.95037515296465
 42
0.0
 10
389.9444086264983
 20
84.24604509030604
 42
0.0
 97
        0
 75
     0
 76
     1
 47
0.0149652027113005
 98
        2
 10
389.4613252420411
 20
82.09415396442526
 10
389.4613252420411
 20
82.09415396442526
450
        0
451
        0
460
0.0
461
0.0
452
        1
462
1.0
453
        2
463
0.0
 63
     5
421
      255
463
1.0
 63
     7
421
 16777215
470
LINEAR
  0
HATCH
  5
1181C
330
18
100
AcDbEntity
  8
0
 62
     0
100
AcDbHatch
 10
0.0
 20
0.0
 30
0.0
210
0.0
220
0.0
230
1.0
  2
SOLID
 70
     1
 71
     1
 91
        1
 92
        7
 72
     1
 73
     1
 93
        2
 10
380.0264694235227
 20
80.0749858473665
 42
1.0
 10
381.7842552717767
 20
80.0749858473665
 42
1.0
 97
        1
330
117CD
 75
     0
 76
     1
 47
0.018860335964173
 98
        1
 10
380.836214864617
 20
80.15735601843917
450
        0
451
        0
460
0.0
461
0.0
452
        1
462
1.0
453
        2
463
0.0
 63
     5
421
      255
463
1.0
 63
     7
421
 16777215
470
LINEAR
  0
HATCH
  5
11842
330
18
100
AcDbEntity
  8
0
 62
     0
100
AcDbHatch
 10
0.0
 20
0.0
 30
0.0
210
0.0
220
0.0
230
1.0
  2
SOLID
 70
     1
 71
     0
 91
        3
 92
        7
 72
     0
 73
     1
 93
       10
 10
390.8554176820119
 20
78.9818217656438
 10
390.8554176820119
 20
76.9486278252343
 10
391.9774433428372
 20
76.9486278252343
 10
394.4216954683747
 20
81.13895427425633
 10
393.2996698075494
 20
81.13895427425633
 10
392.1136909414789
 20
79.10576033384676
 10
392.1136909414789
 20
81.13895427425635
 10
390.9916652806538
 20
81.13895427425635
 10
388.5474131551161
 20
76.94862782523428
 10
389.6694388159414
 20
76.94862782523428
 97
        0
 92
        7
 72
     1
 73
     1
 93
       15
 10
394.335969834464
 20
78.27654847023217
 42
0.0
 10
393.2909318638389
 20
78.27654847023219
 42
0.3900788458737027
 10
393.9008229071384
 20
77.13519174310497
 42
0.2812370958530413
 10
395.7565962141928
 20
77.2950754266805
 42
0.2929411470667126
 10
396.7164771973324
 20
78.71485412427403
 42
0.289901507860161
 10
395.954970074514
 20
79.52067322339693
 42
-0.6151045823147746
 10
395.5134242812653
 20
80.31370322187229
 42
-0.6989373626099215
 10
396.5181033370111
 20
79.95858190032146
 42
0.0
 10
397.6700612971866
 20
79.95858190032143
 42
0.3013131193026421
 10
397.0684358620903
 20
80.93405583793677
 42
0.2487955172635003
 10
395.0974769572823
 20
80.85091595462228
 42
0.3162409350864932
 10
394.271978169664
 20
79.48230132326638
 42
0.2859253974368971
 10
394.6879254936478
 20
78.88113389090321
 42
0.0709266999523229
 10
395.3406458846347
 20
78.6189220748523
 42
-0.5099901666947341
 10
395.5390227505307
 20
78.02415072554344
 42
-0.6281784832477165
 97
        0
 92
        7
 72
     0
 73
     1
 93
       12
 10
398.2072406206726
 20
77.89292603092787
 10
398.6031412361565
 20
78.57164194689855
 10
401.0489831422675
 20
78.57164194689852
 10
401.5998001071237
 20
79.51594015259211
 10
399.1539582010128
 20
79.5159401525921
 10
399.5498588164972
 20
80.19465606856281
 10
401.995700722608
 20
80.19465606856278
 10
402.5465176874642
 20
81.13895427425636
 10
398.9195966129436
 20
81.13895427425636
 10
396.4753444874061
 20
76.94862782523427
 10
400.1022655619269
 20
76.9486278252343
 10
400.6530825267832
 20
77.89292603092787
 97
        0
 75
     0
 76
     1
 47
0.018860335964173
 98
        3
 10
391.366574450013
 20
79.08231675345465
 10
394.7351587743597
 20
77.66779072219859
 10
397.8772823854841
 20
77.55462925279008
450
        0
451
        0
460
0.0
461
0.0
452
        1
462
1.0
453
        2
463
0.0
 63
     5
421
      255
463
1.0
 63
     7
421
 16777215
470
LINEAR
  0
ENDSEC"""
                x = torch.tensor([train_dataset.stoi[s] for s in context], dtype=torch.long)[None,...].to(trainer.device)
                y = model.generate(x, 500, temperature=1.0, do_sample=True, top_k=10)[0]
                completion = ''.join([train_dataset.itos[int(i)] for i in y])
                print(completion)
            # save the latest model
                
            '''generate(prompt="""SECTION
  2
ENTITIES
  0
TEXT
  5
1171E
330
18
100
AcDbEntity
  8
0
100""", num_samples=5, steps=500)'''
            print("saving model")
            from datetime import datetime

            now = datetime.now()

            current_time = now.strftime("%H_%M_%S")
            ckpt_path = os.path.join(config.system.work_dir, current_time+"_"+"model.pt")
            ckpath=ckpt_path
            torch.save(model.state_dict(), ckpath)
            # revert model to training mode
            model.train()

    trainer.set_callback('on_batch_end', batch_end_callback)

    # run the optimization
    trainer.run()
